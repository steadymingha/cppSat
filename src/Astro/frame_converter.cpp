#include "Astro/frame_converter.hpp"

namespace propagator
{
    FrameConverter::FrameConverter() : prev_i_polar_motion_(0),
                                       lunar_solar_elements_(5),
                                       current_jd_(0.0)

    {
        nutation_table_ <<

          0,  0,  0,  0,  1, -171996, -1742, 92025,   89,
          0,  0,  2, -2,  2,  -13187,   -16,  5736,  -31,
          0,  0,  2,  0,  2,   -2274,    -2,   977,   -5,
          0,  0,  0,  0,  2,    2062,     2,  -895,    5,
          0,  -1,  0,  0,  0,   -1426,   34,    54,   -1,
          1,  0,  0,  0,  0,     712,     1,    -7,    0,
          0,  1,  2, -2,  2,    -517,    12,   224,   -6,
          0,  0,  2,  0,  1,    -386,    -4,   200,    0,
          1,  0,  2,  0,  2,    -301,     0,   129,   -1,
          0, -1,  2, -2,  2,     217,    -5,   -95,    3,
         -1,  0,  0,  2,  0,     158,     0,    -1,    0,
          0,  0,  2, -2,  1,     129,     1,   -70,    0,
         -1,  0,  2,  0,  2,     123,     0,   -53,    0,
          1,  0,  0,  0,  1,      63,     1,   -33,    0,
          0,  0,  0,  2,  0,      63,     0,    -2,    0,
         -1,  0,  2,  2,  2,     -59,     0,    26,    0,
         -1,  0,  0,  0,  1,     -58,    -1,    32,    0,
          1,  0,  2,  0,  1,     -51,     0,    27,    0,
         -2,  0,  0,  2,  0,     -48,     0,     1,    0,
         -2,  0,  2,  0,  1,      46,     0,   -24,    0,
          0,  0,  2,  2,  2,     -38,     0,    16,    0,
          2,  0,  2,  0,  2,     -31,     0,    13,    0,
          2,  0,  0,  0,  0,      29,     0,    -1,    0,
          1,  0,  2, -2,  2,      29,     0,   -12,    0,
          0,  0,  2,  0,  0,      26,     0,    -1,    0,
          0,  0,  2, -2,  0,     -22,     0,     0,    0,
         -1,  0,  2,  0,  1,      21,     0,   -10,    0,
          0,  2,  0,  0,  0,      17,    -1,     0,    0,
          0,  2,  2, -2,  2,     -16,     1,     7,    0,
         -1,  0,  0,  2,  1,      16,     0,    -8,    0,
          0,  1,  0,  0,  1,     -15,     0,     9,    0,
          1,  0,  0, -2,  1,     -13,     0,     7,    0,
          0, -1,  0,  0,  1,     -12,     0,     6,    0,
          2,  0, -2,  0,  0,      11,     0,     0,    0,
         -1,  0,  2,  2,  1,     -10,     0,     5,    0,
          1,  0,  2,  2,  2,      -8,     0,     3,    0,
          0, -1,  2,  0,  2,      -7,     0,     3,    0,
          0,  0,  2,  2,  1,      -7,     0,     3,    0,
          1,  1,  0, -2,  0,      -7,     0,     0,    0,
          0,  1,  2,  0,  2,       7,     0,    -3,    0,
         -2,  0,  0,  2,  1,      -6,     0,     3,    0,
          0,  0,  0,  2,  1,      -6,     0,     3,    0,
          2,  0,  2, -2,  2,       6,     0,    -3,    0,
          1,  0,  0,  2,  0,       6,     0,     0,    0,
          1,  0,  2, -2,  1,       6,     0,    -3,    0,
          0,  0,  0, -2,  1,      -5,     0,     3,    0,
          0, -1,  2, -2,  1,      -5,     0,     3,    0,
          2,  0,  2,  0,  1,      -5,     0,     3,    0,
          1, -1,  0,  0,  0,       5,     0,     0,    0,
          1,  0,  0, -1,  0,      -4,     0,     0,    0,
          0,  0,  0,  1,  0,      -4,     0,     0,    0,
          0,  1,  0, -2,  0,      -4,     0,     0,    0,
          1,  0, -2,  0,  0,       4,     0,     0,    0,
          2,  0,  0, -2,  1,       4,     0,    -2,    0,
          0,  1,  2, -2,  1,       4,     0,    -2,    0,
          1,  1,  0,  0,  0,      -3,     0,     0,    0,
          1, -1,  0, -1,  0,      -3,     0,     0,    0,
         -1, -1,  2,  2,  2,      -3,     0,     1,    0,
          0, -1,  2,  2,  2,      -3,     0,     1,    0,
          1, -1,  2,  0,  2,      -3,     0,     1,    0,
          3,  0,  2,  0,  2,      -3,     0,     1,    0,
         -2,  0,  2,  0,  2,      -3,     0,     1,    0,
          1,  0,  2,  0,  0,       3,     0,     0,    0,
         -1,  0,  2,  4,  2,      -2,     0,     1,    0,
          1,  0,  0,  0,  2,      -2,     0,     1,    0,
         -1,  0,  2, -2,  1,      -2,     0,     1,    0,
          0, -2,  2, -2,  1,      -2,     0,     1,    0,
         -2,  0,  0,  0,  1,      -2,     0,     1,    0,
          2,  0,  0,  0,  1,       2,     0,    -1,    0,
          3,  0,  0,  0,  0,       2,     0,     0,    0,
          1,  1,  2,  0,  2,       2,     0,    -1,    0,
          0,  0,  2,  1,  2,       2,     0,    -1,    0,
          1,  0,  0,  2,  1,      -1,     0,     0,    0,
          1,  0,  2,  2,  1,      -1,     0,     1,    0,
          1,  1,  0, -2,  1,      -1,     0,     0,    0,
          0,  1,  0,  2,  0,      -1,     0,     0,    0,
          0,  1,  2, -2,  0,      -1,     0,     0,    0,
          0,  1, -2,  2,  0,      -1,     0,     0,    0,
          1,  0, -2,  2,  0,      -1,     0,     0,    0,
          1,  0, -2, -2,  0,      -1,     0,     0,    0,
          1,  0,  2, -2,  0,      -1,     0,     0,    0,
          1,  0,  0, -4,  0,      -1,     0,     0,    0,
          2,  0,  0, -4,  0,      -1,     0,     0,    0,
          0,  0,  2,  4,  2,      -1,     0,     0,    0,
          0,  0,  2, -1,  2,      -1,     0,     0,    0,
         -2,  0,  2,  4,  2,      -1,     0,     1,    0,
          2,  0,  2,  2,  2,      -1,     0,     0,    0,
          0, -1,  2,  0,  1,      -1,     0,     0,    0,
          0,  0, -2,  0,  1,      -1,     0,     0,    0,
          0,  0,  4, -2,  2,       1,     0,     0,    0,
          0,  1,  0,  0,  2,       1,     0,     0,    0,
          1,  1,  2, -2,  2,       1,     0,    -1,    0,
          3,  0,  2, -2,  2,       1,     0,     0,    0,
         -2,  0,  2,  2,  2,       1,     0,    -1,    0,
         -1,  0,  0,  0,  2,       1,     0,    -1,    0,
          0,  0, -2,  2,  1,       1,     0,     0,    0,
          0,  1,  2,  0,  1,       1,     0,     0,    0,
         -1,  0,  4,  0,  2,       1,     0,     0,    0,
          2,  1,  0, -2,  0,       1,     0,     0,    0,
          2,  0,  0,  2,  0,       1,     0,     0,    0,
          2,  0,  2, -2,  1,       1,     0,    -1,    0,
          2,  0, -2,  0,  1,       1,     0,     0,    0,
          1, -1,  0, -2,  0,       1,     0,     0,    0,
         -1,  0,  0,  1,  1,       1,     0,     0,    0,
         -1, -1,  0,  2,  1,       1,     0,     0,    0,
          0,  1,  0,  1,  0,       1,     0,     0,    0;

    }

    ErrorCode FrameConverter::ReadEarthRotationParameterFromIERS(const std::string &iers_fdir)
    {
        std::vector<std::string> item_list;

        TimeConverter& time_setup = TimeConverter::getInstance();
        ErrorCode r_status = time_setup.ReadLeapSecondFromIERS(iers_fdir);
        if (r_status != ErrorCode::SUCCESS) return r_status;

        ParameterParsing parsed_data(iers_fdir);

        while (1)
        {
            parsed_data.get_item_list(item_list);
            if (item_list.empty()) break;
            if (item_list[0] == "UT1UTC/XY")
            {
                uint16_t eop_cnt = std::stoi(item_list[1]);
                if (eop_cnt <= 0) return ErrorCode::ERROR_NO_EARTH_ORIENTATION_PARAMETER_IN_IERS_FILE;
//                {
//                    //throw error message!!
//                }
                polar_motion_.resize(eop_cnt);
                for (int i = 0; i < eop_cnt; i++)
                {
                    parsed_data.get_item_list(item_list);
                    polar_motion_[i].jd_ = std::stod(item_list[1]);
                    polar_motion_[i].xp_ = std::stod(item_list[3]) * sim_param::arcsec2rad;
                    polar_motion_[i].yp_ = std::stod(item_list[4]) * sim_param::arcsec2rad;
                }
                num_polar_motion_entries_ = eop_cnt;

            }
        }
        return r_status;

    }
}

